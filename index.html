<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyberpunk Game</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=VT323&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styles.css">

</head>
<body>
    <div class="app-skeleton">
        <header class="app-header">
            <div class="logo-button">
                <button class="logo-button__button">
                    ECOS
                </button>
            </div>
            <div class="connect-wallet">
                <button class="connect-wallet__button">
                    <i class="fas fa-wallet"></i>
                    Connect Wallet
                </button>
            </div>
            <div class="header-actions">
                <a href="#" class="header-action-link">
                    <i class="fas fa-bell header-action-icon"></i>
                    <span class="header-action-badge">3</span>
                </a>
                <a href="#" class="header-action-link">
                    <i class="fas fa-cog header-action-icon"></i>
                </a>
            </div>
        </header>

        <div class="stats-bar">
            <div class="stats-item">
                <i class="fab fa-bitcoin stats-icon"></i>
                <span class="stats-value">1.6688 BTC</span>
            </div>
            <div class="stats-item">
                <i class="fas fa-coins stats-icon"></i>
                <span class="stats-value">20147 ECOS Points</span>
            </div>
            <div class="stats-item">
                <i class="fas fa-level-up-alt stats-icon"></i>
                <span class="stats-value">LVL 0/10</span>
            </div>
        </div>

        <main class="app-main">
            <div class="circular-buttons">
                <div class="circular-button">
                    <span>200kw/1000kw</span>
                </div>
                <div class="circular-button">
                    <span>234Th</span>
                </div>
                <div class="circular-button">
                    <i class="fas fa-chart-line"></i>
                    <span>Progress</span>
                </div>
            </div>
            <div class="timer">5:33:10</div>
            <button class="start-mining-button">Start Mining</button>
            <div class="game-content">
                <div class="asic-miner">
                    <div class="asic-miner__image"></div>
                    <div class="asic-miner__text">ASIC Miner</div>
                </div>
                <div class="game-buttons">
                    <div class="game-buttons__left">
                        <button class="game-button game-button--primary">
                            <i class="fas fa-bolt"></i>
                            Daily Combo
                        </button>
                        <button class="game-button game-button--secondary">
                            <i class="fas fa-gift"></i>
                            Special Offers
                        </button>
                    </div>
                    <div class="game-buttons__right">
                        <button class="game-button game-button--primary">
                            <i class="fas fa-tasks"></i>
                            Daily Tasks
                        </button>
                        <button class="game-button game-button--secondary">
                            <i class="fas fa-arrow-up"></i>
                            Upgrade
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Modal for Exchange Confirmation -->
        <div class="modal-overlay" id="exchange-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Confirm Exchange</h3>
                </div>
                <div class="modal-body" id="exchange-confirmation-text">
                    Are you sure you want to exchange <span id="modal-btc-amount">0</span> BTC for <span id="modal-ecos-amount">0</span> ECOS Points?
                </div>
                <div class="modal-buttons">
                    <button class="modal-button modal-button--yes" id="confirm-exchange">Yes</button>
                    <button class="modal-button modal-button--no" id="cancel-exchange">No</button>
                </div>
            </div>
        </div>

        <nav class="bottom-nav">
            <ul class="bottom-nav__list">
                <li class="bottom-nav__item">
                    <a href="#" class="bottom-nav__link">
                        <i class="fas fa-store bottom-nav__icon"></i>
                        <span class="bottom-nav__text">Store</span>
                    </a>
                </li>
                <li class="bottom-nav__item">
                    <a href="#" class="bottom-nav__link">
                        <i class="fas fa-chart-line bottom-nav__icon"></i>
                        <span class="bottom-nav__text">Stat</span>
                    </a>
                </li>
                <li class="bottom-nav__item">
                    <a href="#" class="bottom-nav__link bottom-nav__link--active">
                        <i class="fas fa-home bottom-nav__icon"></i>
                        <span class="bottom-nav__text">Home</span>
                    </a>
                </li>
                <li class="bottom-nav__item">
                    <a href="#" class="bottom-nav__link">
                        <i class="fas fa-coins bottom-nav__icon"></i>
                        <span class="bottom-nav__text">Earn</span>
                    </a>
                </li>
                <li class="bottom-nav__item">
                    <a href="#" class="bottom-nav__link">
                        <i class="fas fa-wallet bottom-nav__icon"></i>
                        <span class="bottom-nav__text">Wallet</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let startMiningButton = document.querySelector('.start-mining-button');
            let timerDisplay = document.querySelector('.timer');
            let btcBalanceDisplay = document.querySelector('.stats-item:first-child .stats-value');
            let energyDisplay = document.querySelector('.circular-button:first-child span');

            let miningInterval;
            const miningDuration = 1 * 60; // 1 minute in seconds
            const profitAmount = 0.0001287;
            const energyCostPerSession = 3.51; // Energy cost for one mining session
            let timeRemaining = miningDuration;

            function formatTime(seconds) {
                const h = Math.floor(seconds / 3600);
                const m = Math.floor((seconds % 3600) / 60);
                const s = seconds % 60;
                return `${h}:${m < 10 ? '0' : ''}${m}:${s < 10 ? '0' : ''}${s}`;
            }

            function updateTimerDisplay() {
                if (timerDisplay) {
                     timerDisplay.textContent = formatTime(timeRemaining);
                }
            }

            function addProfit() {
                // Re-select btcBalanceDisplay before using it
                const currentBtcBalanceDisplay = document.querySelector('.stats-item:first-child .stats-value');
                if (!currentBtcBalanceDisplay) { // Add a check just in case
                     console.error('BTC balance element not found.');
                     return;
                }
                try {
                    const currentBtcText = currentBtcBalanceDisplay.textContent;
                    const currentBtcValue = parseFloat(currentBtcText.replace(' BTC', ''));
                    if (!isNaN(currentBtcValue)) {
                        const newBtcValue = currentBtcValue + profitAmount;
                        currentBtcBalanceDisplay.textContent = `${newBtcValue.toFixed(8)} BTC`;
                    } else {
                         console.error('Could not parse current BTC value:', currentBtcText);
                    }
                } catch (error) {
                    console.error('Error adding profit:', error);
                }
            }

            function handleButtonClick(targetButton) {
                // Re-select energyDisplay and timerDisplay before using them
                const currentEnergyDisplay = document.querySelector('.circular-button:first-child span');
                const currentTimerDisplay = document.querySelector('.timer');

                if (!currentEnergyDisplay || !currentTimerDisplay) { // Add a check just in case
                     console.error('Energy or Timer element not found.');
                     return;
                }

                if (targetButton.textContent === 'Start Mining') {
                    // Check and consume energy before starting
                    const energyText = currentEnergyDisplay.textContent;
                    const energyMatch = energyText.match(/^(\d+(\.\d+)?)(?:kw)?\/(\d+(\.\d+)?)(?:kw)?$/);

                    if (energyMatch) {
                        let currentEnergy = parseFloat(energyMatch[1]);
                        const maxEnergy = parseFloat(energyMatch[3]);

                        if (!isNaN(currentEnergy) && currentEnergy >= energyCostPerSession) {
                            // Deduct energy
                            currentEnergy -= energyCostPerSession;
                            // Update energy display
                            currentEnergyDisplay.textContent = `${currentEnergy.toFixed(2)}kw/${maxEnergy}kw`;

                            // Start Mining
                            targetButton.disabled = true;
                            targetButton.textContent = 'Mining...';
                            currentTimerDisplay.style.visibility = 'visible';

                            timeRemaining = miningDuration;
                            // Use a local variable for interval and clear it correctly
                            let currentMiningInterval = setInterval(() => {
                                timeRemaining--;
                                // Make sure to update the correct timer display
                                if (document.querySelector('.timer')){
                                     document.querySelector('.timer').textContent = formatTime(timeRemaining);
                                }


                                if (timeRemaining <= 0) {
                                    clearInterval(currentMiningInterval); // Clear the current interval
                                    targetButton.disabled = false; // Enable button
                                    targetButton.textContent = 'Claim'; // Change text to Claim
                                    if (document.querySelector('.timer')){
                                         document.querySelector('.timer').style.visibility = 'hidden'; // Hide timer
                                    }
                                }
                            }, 1000);
                            // Store the interval ID in the outer scope to clear it later if needed (e.g., on screen change)
                             miningInterval = currentMiningInterval;

                        } else {
                            // Insufficient energy
                            alert('Недостаточно энергии для майнинга!');
                        }
                    } else {
                         console.error('Could not parse energy value:', energyText);
                         alert('Ошибка определения количества энергии.');
                    }
                } else if (targetButton.textContent === 'Claim') {
                    // Claim Profit
                    addProfit();
                    targetButton.textContent = 'Start Mining';
                }
                // If text is 'Mining...', do nothing (button is disabled)
            }

            // Initial display setup
            if (timerDisplay) {
                 timerDisplay.textContent = formatTime(miningDuration);
                 timerDisplay.style.visibility = 'hidden'; // Initially hide timer
            }

            // Use event delegation for the start mining button
             const appMain = document.querySelector('.app-main');

             if (appMain) {
                 appMain.addEventListener('click', (event) => {
                     const targetButton = event.target.closest('.start-mining-button');
                     if (targetButton) {
                         handleButtonClick(targetButton);
                     }
                 });
             }

            // Store the initial HTML of app-main
            const initialAppMainContent = appMain ? appMain.innerHTML : '';

            // Add event listener to the Store button
            const storeButton = document.querySelector('.bottom-nav__link i.fas.fa-store').closest('a');

            if (storeButton && appMain) {
                storeButton.addEventListener('click', (event) => {
                    event.preventDefault(); // Prevent default link behavior

                    console.log('Store button clicked!'); // Log when Store button is clicked

                    // Before changing content, clear any running mining interval
                    if (miningInterval) {
                        clearInterval(miningInterval);
                        console.log('Mining interval cleared (Store).'); // Log when interval is cleared for Store
                    }

                    // Generate HTML for the Store screen
                    const storeScreenHTML = `
                        <div class="store-filter-bar">
                            <button class="filter-button active">Premium</button>
                            <button class="filter-button">ASICs</button>
                            <button class="filter-button">ECOS Points</button>
                            <button class="filter-button">Energy</button>
                            <button class="filter-button">Boosts</button>
                            <button class="filter-button">Land</button>
                            <button class="filter-button">Datacenter</button>
                            <button class="filter-button">EnergyStation</button>
                        </div>
                        <div id="store-content-area">
                            <div class="filter-content" id="energy-content">
                                <div class="store-slots">
                                    <div class="store-slot">
                                        <div class="slot-content">
                                            <div class="slot-icon">⚡</div>
                                            <div class="slot-info">
                                                <div class="slot-name">90 kW</div>
                                                <div class="slot-price">90 ECOS Points</div>
                                            </div>
                                        </div>
                                        <button class="buy-button">Buy</button>
                                    </div>
                                    <div class="store-slot">
                                        <div class="slot-content">
                                            <div class="slot-icon">⚡</div>
                                            <div class="slot-info">
                                                <div class="slot-name">350 kW</div>
                                                <div class="slot-price">17.36 ECOS Points</div>
                                            </div>
                                        </div>
                                        <button class="buy-button">Buy</button>
                                    </div>
                                    <div class="store-slot">
                                        <div class="slot-content">
                                            <div class="slot-icon">⚡</div>
                                            <div class="slot-info">
                                                <div class="slot-name">1800 kW</div>
                                                <div class="slot-price">89.28 ECOS Points</div>
                                            </div>
                                        </div>
                                        <button class="buy-button">Buy</button>
                                    </div>
                                    <div class="store-slot">
                                        <div class="slot-content">
                                            <div class="slot-icon">⚡</div>
                                            <div class="slot-info">
                                                <div class="slot-name">11000 kW</div>
                                                <div class="slot-price">545.60 ECOS Points</div>
                                            </div>
                                        </div>
                                        <button class="buy-button">Buy</button>
                                    </div>
                                    <div class="store-slot">
                                        <div class="slot-content">
                                            <div class="slot-icon">⚡</div>
                                            <div class="slot-info">
                                                <div class="slot-name">18000 kW</div>
                                                <div class="slot-price">892.80 ECOS Points</div>
                                            </div>
                                        </div>
                                        <button class="buy-button">Buy</button>
                                    </div>
                                    <div class="store-slot">
                                        <div class="slot-content">
                                            <div class="slot-icon">⚡</div>
                                            <div class="slot-info">
                                                <div class="slot-name">72300 kW</div>
                                                <div class="slot-price">3586.08 ECOS Points</div>
                                            </div>
                                        </div>
                                        <button class="buy-button">Buy</button>
                                    </div>
                                    <div class="store-slot">
                                        <div class="slot-content">
                                            <div class="slot-icon">⚡</div>
                                            <div class="slot-info">
                                                <div class="slot-name">253300 kW</div>
                                                <div class="slot-price">12563.68 ECOS Points</div>
                                            </div>
                                        </div>
                                        <button class="buy-button">Buy</button>
                                    </div>
                                    <div class="store-slot">
                                        <div class="slot-content">
                                            <div class="slot-icon">⚡</div>
                                            <div class="slot-info">
                                                <div class="slot-name">1267100 kW</div>
                                                <div class="slot-price">62848.16 ECOS Points</div>
                                            </div>
                                        </div>
                                        <button class="buy-button">Buy</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    appMain.innerHTML = storeScreenHTML; // Replace content with filter bar and content area
                    console.log('appMain content set for Store:', appMain.innerHTML); // Log the content being set

                    // Get the content area element
                    const storeContentArea = appMain.querySelector('#store-content-area');

                    // Function to load content based on filter
                    const loadStoreContent = (filterType) => {
                        let contentHTML = '';
                        if (filterType === 'Premium') {
                            contentHTML = `
                                <div class="store-subfilter">
                                     <button class="store-subfilter__button active">TON</button>
                                     <button class="store-subfilter__button">Stars</button>
                                </div>
                                <div class="store-item-slots">
                                    <div class="store-item-slot">
                                        <div class="item-image-placeholder"></div>
                                        <div class="item-text">Premium 7 days</div>
                                        <div class="item-price">1.56 TON</div>
                                        <button class="buy-button">Buy</button>
                                    </div>
                                    <div class="store-item-slot">
                                        <div class="item-image-placeholder"></div>
                                        <div class="item-text">Premium 15 days</div>
                                        <div class="item-price">3.13 TON</div>
                                        <button class="buy-button">Buy</button>
                                    </div>
                                    <div class="store-item-slot">
                                        <div class="item-image-placeholder"></div>
                                        <div class="item-text">Premium 30 days</div>
                                        <div class="item-price">4.69 TON</div>
                                        <button class="buy-button">Buy</button>
                                    </div>
                                </div>
                            `;
                        } else if (filterType === 'ASICs') {
                             const asicAmounts = [1, 20, 50, 100, 200, 500, 1000, 5000];
                             const asicPrices = [6250, 125000, 312500, 625000, 1250000, 3125000, 6250000, 12500000]; // Prices in ECOS Points
                             let asicSlotsHTML = '';
                             asicAmounts.forEach((amount, index) => {
                                 const price = asicPrices[index];
                                 asicSlotsHTML += `
                                     <div class="store-item-slot">
                                         <div class="item-image-placeholder"></div>
                                         <div class="item-text">${amount} ASIC</div>
                                         <div class="item-price">${price} ECOS Points</div>
                                         <button class="buy-button">Buy</button>
                                     </div>
                                 `;
                             });
                             contentHTML = `<div class="store-item-slots">${asicSlotsHTML}</div>`;
                        } else if (filterType === 'ECOS Points') {
                            contentHTML = `
                                <div class="store-subfilter">
                                     <button class="store-subfilter__button active">TON</button>
                                     <button class="store-subfilter__button">Stars</button>
                                </div>
                                <div class="store-item-slots">
                                    <div class="store-item-slot">
                                        <div class="item-image-placeholder"></div>
                                        <div class="item-text">5000 ECOS Points</div>
                                        <div class="item-price">1 TON</div>
                                        <button class="buy-button">Buy</button>
                                    </div>
                                    <div class="store-item-slot">
                                        <div class="item-image-placeholder"></div>
                                        <div class="item-text">10000 ECOS Points</div>
                                        <div class="item-price">2 TON</div>
                                        <button class="buy-button">Buy</button>
                                    </div>
                                    <div class="store-item-slot">
                                        <div class="item-image-placeholder"></div>
                                        <div class="item-text">15000 ECOS Points</div>
                                        <div class="item-price">3 TON</div>
                                        <button class="buy-button">Buy</button>
                                    </div>
                                    <div class="store-item-slot">
                                        <div class="item-image-placeholder"></div>
                                        <div class="item-text">20000 ECOS Points</div>
                                        <div class="item-price">4 TON</div>
                                        <button class="buy-button">Buy</button>
                                    </div>
                                    <div class="store-item-slot">
                                        <div class="item-image-placeholder"></div>
                                        <div class="item-text">50000 ECOS Points</div>
                                        <div class="item-price">9.5 TON</div>
                                        <button class="buy-button">Buy</button>
                                    </div>
                                    <div class="store-item-slot">
                                        <div class="item-image-placeholder"></div>
                                        <div class="item-text">100000 ECOS Points</div>
                                        <div class="item-price">15 TON</div>
                                        <button class="buy-button">Buy</button>
                                    </div>
                                </div>
                            `;
                        } else if (filterType === 'Energy') {
                            contentHTML = `
                                <div class="store-item-slots">
                                    <div class="store-item-slot">
                                        <div class="item-image-placeholder"></div>
                                        <div class="item-text">90 kW</div>
                                        <div class="item-price">90 ECOS Points</div>
                                        <button class="buy-button">Buy</button>
                                    </div>
                                    <div class="store-item-slot">
                                        <div class="item-image-placeholder"></div>
                                        <div class="item-text">350 kW</div>
                                        <div class="item-price">17.36 ECOS Points</div>
                                        <button class="buy-button">Buy</button>
                                    </div>
                                    <div class="store-item-slot">
                                        <div class="item-image-placeholder"></div>
                                        <div class="item-text">1800 kW</div>
                                        <div class="item-price">89.28 ECOS Points</div>
                                        <button class="buy-button">Buy</button>
                                    </div>
                                    <div class="store-item-slot">
                                        <div class="item-image-placeholder"></div>
                                        <div class="item-text">11000 kW</div>
                                        <div class="item-price">545.60 ECOS Points</div>
                                        <button class="buy-button">Buy</button>
                                    </div>
                                    <div class="store-item-slot">
                                        <div class="item-image-placeholder"></div>
                                        <div class="item-text">18000 kW</div>
                                        <div class="item-price">892.80 ECOS Points</div>
                                        <button class="buy-button">Buy</button>
                                    </div>
                                    <div class="store-item-slot">
                                        <div class="item-image-placeholder"></div>
                                        <div class="item-text">72300 kW</div>
                                        <div class="item-price">3586.08 ECOS Points</div>
                                        <button class="buy-button">Buy</button>
                                    </div>
                                    <div class="store-item-slot">
                                        <div class="item-image-placeholder"></div>
                                        <div class="item-text">253300 kW</div>
                                        <div class="item-price">12563.68 ECOS Points</div>
                                        <button class="buy-button">Buy</button>
                                    </div>
                                    <div class="store-item-slot">
                                        <div class="item-image-placeholder"></div>
                                        <div class="item-text">1267100 kW</div>
                                        <div class="item-price">62848.16 ECOS Points</div>
                                        <button class="buy-button">Buy</button>
                                    </div>
                                </div>
                            `;
                        } else if (filterType === 'Land') {
                            contentHTML = `
                                <div class="store-item-slots">
                                    <div class="store-item-slot">
                                        <div class="item-image-placeholder"></div>
                                        <div class="item-text">Land</div>
                                        <div class="item-price">10000 ECOS Points</div>
                                        <div class="item-ownership">1/137</div>
                                        <button class="buy-button">Buy</button>
                                    </div>
                                </div>
                            `;
                        } else if (filterType === 'Datacenter') {
                            contentHTML = `
                                <div class="store-item-slots">
                                    <div class="store-item-slot">
                                        <div class="item-image-placeholder"></div>
                                        <div class="item-text">Datacenter</div>
                                        <div class="item-price">50000 ECOS Points</div>
                                        <div class="item-ownership">1/137</div>
                                        <button class="buy-button">Buy</button>
                                    </div>
                                </div>
                            `;
                        } else if (filterType === 'EnergyStation') {
                            contentHTML = `
                                <div class="store-item-slots">
                                    <div class="store-item-slot">
                                        <div class="item-image-placeholder"></div>
                                        <div class="item-text">EnergyStation</div>
                                        <div class="item-price">10000 ECOS Points</div>
                                        <div class="item-ownership">1/137</div>
                                        <button class="buy-button">Buy</button>
                                    </div>
                                </div>
                            `;
                        } else if (filterType === 'Boosts') {
                            contentHTML = `
                                <div class="store-subfilter">
                                    <button class="store-subfilter__button active">TON</button>
                                    <button class="store-subfilter__button">Stars</button>
                                </div>
                                <div class="store-item-slots">
                                    <div class="store-item-slot">
                                        <div class="item-image-placeholder"></div>
                                        <div class="item-text">Boost 1</div>
                                        <button class="buy-button">Buy</button>
                                    </div>
                                    <div class="store-item-slot">
                                        <div class="item-image-placeholder"></div>
                                        <div class="item-text">Boost 2</div>
                                        <button class="buy-button">Buy</button>
                                    </div>
                                    <div class="store-item-slot">
                                        <div class="item-image-placeholder"></div>
                                        <div class="item-text">Boost 3</div>
                                        <button class="buy-button">Buy</button>
                                    </div>
                                </div>
                            `;
                        } else {
                            contentHTML = `<h2>${filterType} Content</h2><p>Content for ${filterType} will go here.</p>`;
                        }
                        if (storeContentArea) {
                             storeContentArea.innerHTML = contentHTML;
                             console.log(`Content loaded for filter: ${filterType}`);
                        }
                    };

                    // Load default content (Premium) when Store screen opens
                    loadStoreContent('Premium');

                    // Add click handlers for filter buttons
                    const filterButtons = appMain.querySelectorAll('.filter-button');
                    filterButtons.forEach(button => {
                        button.addEventListener('click', () => {
                            // Remove active class from all buttons
                            filterButtons.forEach(btn => btn.classList.remove('active'));
                            // Add active class to clicked button
                            button.classList.add('active');
                            // Load content for selected filter
                            loadStoreContent(button.textContent);
                        });
                    });

                    // Add event listeners to filter buttons using delegation on appMain
                     appMain.addEventListener('click', (event) => {
                         const filterButton = event.target.closest('.filter-button');
                         if (filterButton) {
                             // Remove active class from all filter buttons
                             appMain.querySelectorAll('.filter-button').forEach(btn => btn.classList.remove('active'));
                             // Add active class to the clicked button
                             filterButton.classList.add('active');
                             // Load content based on the clicked filter's text
                             loadStoreContent(filterButton.textContent);
                         }

                         // Add event listener for subfilter buttons (TON/Stars) using delegation
                          const subfilterButton = event.target.closest('.store-subfilter__button');
                          if (subfilterButton) {
                               // Handle subfilter click (e.g., update active class for subfilter buttons)
                              console.log(`Subfilter button clicked: ${subfilterButton.textContent}`);
                               // Remove active class from all subfilter buttons
                              appMain.querySelectorAll('.store-subfilter__button').forEach(btn => btn.classList.remove('active'));
                               // Add active class to the clicked subfilter button
                              subfilterButton.classList.add('active');
                               // Add logic here to filter items based on subfilter
                          }

                         // Add event listener for Buy buttons using delegation
                          const buyButton = event.target.closest('.buy-button');
                          if (buyButton) {
                              // Handle buy button click
                             const itemSlot = buyButton.closest('.store-item-slot');
                             const itemText = itemSlot ? itemSlot.querySelector('.item-text').textContent : 'Unknown Item';
                              console.log(`Buy button clicked for item: ${itemText}`);
                               // Add your purchase logic here
                               alert(`Покупка: ${itemText}`);
                          }
                     });


                    // Optionally update active class for navigation links
                    document.querySelectorAll('.bottom-nav__link').forEach(link => link.classList.remove('bottom-nav__link--active'));
                    storeButton.classList.add('bottom-nav__link--active');
                    console.log('Active class updated for Store button.');

                    // Clear references to old elements (these might be re-selected within loadStoreContent if needed)
                    startMiningButton = null;
                    timerDisplay = null;
                    // btcBalanceDisplay and energyDisplay are re-selected in their functions
                });
            }

            // Add event listener to the Home button to switch back to home content
            const homeButton = document.querySelector('.bottom-nav__link i.fas.fa-home').closest('a');

            if (homeButton && appMain && initialAppMainContent) {
                 homeButton.addEventListener('click', (event) => {
                    event.preventDefault(); // Prevent default link behavior

                    console.log('Home button clicked!'); // Log when Home button is clicked
                    console.log('Initial appMain content stored:', initialAppMainContent); // Log the stored content

                    // Before restoring content, clear any running mining interval
                    if (miningInterval) {
                        clearInterval(miningInterval);
                        console.log('Mining interval cleared.'); // Log when interval is cleared
                    }
                    // Restore the initial app-main content
                    appMain.innerHTML = initialAppMainContent;
                    console.log('appMain content restored.'); // Log after restoring content

                    // Re-select elements and update outer scope references
                    startMiningButton = appMain.querySelector('.start-mining-button');
                    timerDisplay = appMain.querySelector('.timer');
                    // btcBalanceDisplay and energyDisplay will be re-selected within their functions

                    console.log('startMiningButton after restore:', startMiningButton); // Log re-selected startMiningButton
                    console.log('timerDisplay after restore:', timerDisplay); // Log re-selected timerDisplay

                    // Ensure timer visibility is correct after restoring
                    if (startMiningButton && timerDisplay) { // Add checks
                         if (startMiningButton.textContent !== 'Mining...') {
                             timerDisplay.style.visibility = 'hidden';
                             console.log('Timer visibility set to hidden.');
                         } else {
                              timerDisplay.style.visibility = 'visible';
                              console.log('Timer visibility set to visible.');
                         }
                         updateTimerDisplay(); // Update timer display with current timeRemaining
                         console.log('Timer display updated.');
                    }

                    // Optionally update active class for navigation links
                    document.querySelectorAll('.bottom-nav__link').forEach(link => link.classList.remove('bottom-nav__link--active'));
                    homeButton.classList.add('bottom-nav__link--active');
                    console.log('Active class updated for Home button.');

                 });
            }

             // Initialize active class on page load
            const activeLink = document.querySelector('.bottom-nav__link--active');
            if (activeLink) {
                activeLink.classList.remove('bottom-nav__link--active');
            }
            // Find the Home button again after potential content changes (though it shouldn't change here)
             const initialHomeButton = document.querySelector('.bottom-nav__link i.fas.fa-home').closest('a');
             if(initialHomeButton) {
                initialHomeButton.classList.add('bottom-nav__link--active');
             }

            // Add event listener to the Stat button
            const statButton = document.querySelector('.bottom-nav__link i.fas.fa-chart-line').closest('a');

            if (statButton && appMain) {
                statButton.addEventListener('click', (event) => {
                    event.preventDefault(); // Prevent default link behavior
                    // Before changing content, clear any running mining interval
                    if (miningInterval) {
                        clearInterval(miningInterval);
                    }
                    appMain.innerHTML = '<h2>Stat Screen Content</h2><p>This is where the statistics content will go.</p>'; // Replace content
                    // Optionally update active class for navigation links
                    document.querySelectorAll('.bottom-nav__link').forEach(link => link.classList.remove('bottom-nav__link--active'));
                    statButton.classList.add('bottom-nav__link--active');

                    // Clear references to elements that are not on the stat screen
                    startMiningButton = null;
                    timerDisplay = null;
                     // btcBalanceDisplay and energyDisplay might be needed on stat screen, depending on content
                     // For now, clear their references to be safe
                    btcBalanceDisplay = null;
                    energyDisplay = null;

                });
            }

            // Add event listener to the Earn button
            const earnButton = document.querySelector('.bottom-nav__link i.fas.fa-coins').closest('a');

            if (earnButton && appMain) {
                earnButton.addEventListener('click', (event) => {
                    event.preventDefault(); // Prevent default link behavior
                     // Before changing content, clear any running mining interval
                    if (miningInterval) {
                        clearInterval(miningInterval);
                    }
                    appMain.innerHTML = '<h2>Earn Screen Content</h2><p>This is where the earn content will go.</p>'; // Replace content
                    // Optionally update active class for navigation links
                    document.querySelectorAll('.bottom-nav__link').forEach(link => link.classList.remove('bottom-nav__link--active'));
                    earnButton.classList.add('bottom-nav__link--active');

                     // Clear references to elements that are not on the earn screen
                    startMiningButton = null;
                    timerDisplay = null;
                    btcBalanceDisplay = null;
                    energyDisplay = null;

                });
            }

            // Add event listener to the Wallet button
            const walletButton = document.querySelector('.bottom-nav__link i.fas.fa-wallet').closest('a');

            if (walletButton && appMain) {
                walletButton.addEventListener('click', (event) => {
                    event.preventDefault(); // Prevent default link behavior
                     // Before changing content, clear any running mining interval
                    if (miningInterval) {
                        clearInterval(miningInterval);
                    }
                    const walletScreenHTML = `
                        <div class="wallet-screen">
                            <div class="wallet-balances">
                                <div class="wallet-balance-item">
                                    <div class="balance-icon">
                                        <i class="fab fa-bitcoin"></i>
                                    </div>
                                    <div class="balance-info">
                                        <div class="balance-label">BTC Balance</div>
                                        <div class="balance-value" id="btc-balance">1.6688 BTC</div>
                                    </div>
                                </div>
                                <div class="wallet-balance-item">
                                    <div class="balance-icon">
                                        <i class="fas fa-coins"></i>
                                    </div>
                                    <div class="balance-info">
                                        <div class="balance-label">ECOS Points</div>
                                        <div class="balance-value" id="ecos-balance">20147 ECOS Points</div>
                                    </div>
                                </div>
                            </div>
                            <div class="btc-price-section">
                                <div class="price-header">
                                    <h2>BTC Price</h2>
                                    <div class="price-refresh">
                                        <button id="refresh-price">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="price-content">
                                    <div class="price-item">
                                        <div class="price-label">Price</div>
                                        <div class="exchange-price" id="btc-price">Loading...</div>
                                    </div>
                                </div>
                            </div>
                            <div class="exchange-section">
                                <div class="exchange-header">
                                    <h2>Exchange BTC to ECOS Points</h2>
                                </div>
                                <div class="exchange-content">
                                    <div class="exchange-input-group">
                                        <div class="exchange-label">You send</div>
                                        <div class="exchange-input-wrapper">
                                            <input type="number" id="btc-amount" min="0" step="0.00000001" placeholder="0.00000000">
                                            <div class="exchange-currency">BTC</div>
                                        </div>
                                    </div>
                                    <div class="exchange-arrow">
                                        <i class="fas fa-exchange-alt"></i>
                                    </div>
                                    <div class="exchange-input-group">
                                        <div class="exchange-label">You receive</div>
                                        <div class="exchange-input-wrapper">
                                            <input type="number" id="ecos-amount" readonly placeholder="0">
                                            <div class="exchange-currency">ECOS Points</div>
                                        </div>
                                    </div>
                                    <div class="exchange-rate">
                                        <span>Rate: </span>
                                        <span id="exchange-rate">1 BTC = 0 ECOS Points</span>
                                    </div>
                                    <button class="exchange-button" id="exchange-button">Exchange</button>
                                </div>
                            </div>
                        </div>
                    `;
                    appMain.innerHTML = walletScreenHTML;

                    // Функция для обновления цены BTC через WebSocket
                    function initBTCPrice() {
                        const ws = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@trade');
                        
                        ws.onmessage = (event) => {
                            try {
                                const data = JSON.parse(event.data);
                                const price = parseFloat(data.p);
                                // Сохраняем цену в data-атрибуте для точного использования
                                document.getElementById('btc-price').setAttribute('data-price', price);
                                document.getElementById('btc-price').textContent = `$${price.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                                
                                // Обновляем курс обмена
                                updateExchangeRate(price);
                            } catch (error) {
                                console.error('Error parsing WebSocket data:', error);
                            }
                        };

                        ws.onerror = (error) => {
                            console.error('WebSocket error:', error);
                            document.getElementById('btc-price').textContent = 'Error';
                        };

                        ws.onclose = () => {
                            console.log('WebSocket connection closed');
                            // Попытка переподключения через 5 секунд
                            setTimeout(initBTCPrice, 5000);
                        };

                        // Обработчик для кнопки обновления
                        document.getElementById('refresh-price').addEventListener('click', () => {
                            if (ws.readyState === WebSocket.OPEN) {
                                ws.send(JSON.stringify({ method: "SUBSCRIBE", params: ["btcusdt@trade"], id: 1 }));
                            }
                        });
                    }

                    // Функция обновления курса обмена
                    function updateExchangeRate(btcPrice) {
                        const rateElement = document.getElementById('exchange-rate');
                        rateElement.textContent = `1 BTC = ${btcPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} ECOS Points`;
                    }

                    // Функция обновления суммы ECOS Points при вводе BTC
                    function updateEcosAmount() {
                        const btcInput = document.getElementById('btc-amount');
                        const ecosInput = document.getElementById('ecos-amount');
                        // Используем сохраненное точное значение цены
                        const btcPrice = parseFloat(document.getElementById('btc-price').getAttribute('data-price'));
                        
                        if (btcInput.value && btcPrice) {
                            const ecosAmount = parseFloat(btcInput.value) * btcPrice;
                            ecosInput.value = Math.floor(ecosAmount).toString();
                        } else {
                            ecosInput.value = '';
                        }
                    }

                    // Добавляем обработчики событий
                    document.getElementById('btc-amount').addEventListener('input', updateEcosAmount);

                    // Обработчик кнопки обмена
                    document.getElementById('exchange-button').addEventListener('click', () => {
                        const btcAmount = parseFloat(document.getElementById('btc-amount').value);
                        const ecosAmount = parseFloat(document.getElementById('ecos-amount').value);
                        
                        if (btcAmount > 0 && ecosAmount > 0) {
                            // Показываем модальное окно
                            const modal = document.getElementById('exchange-modal');
                            document.getElementById('modal-btc-amount').textContent = btcAmount.toFixed(8);
                            document.getElementById('modal-ecos-amount').textContent = Math.floor(ecosAmount).toString();
                            modal.classList.add('active');
                        } else {
                            alert('Please enter a valid amount');
                        }
                    });

                    // Обработчик кнопки Yes в модальном окне
                    document.getElementById('confirm-exchange').addEventListener('click', () => {
                        const btcAmount = parseFloat(document.getElementById('btc-amount').value);
                        const ecosAmount = parseFloat(document.getElementById('ecos-amount').value);
                        
                        // Получаем текущие балансы
                        const currentBtcBalance = parseFloat(document.getElementById('btc-balance').textContent);
                        const currentEcosBalance = parseFloat(document.getElementById('ecos-balance').textContent);
                        
                        // Проверяем, достаточно ли BTC
                        if (currentBtcBalance >= btcAmount) {
                            // Обновляем балансы
                            const newBtcBalance = (currentBtcBalance - btcAmount).toFixed(8);
                            const newEcosBalance = Math.floor(currentEcosBalance + ecosAmount);
                            
                            // Обновляем отображение балансов
                            document.getElementById('btc-balance').textContent = newBtcBalance + ' BTC';
                            document.getElementById('ecos-balance').textContent = newEcosBalance + ' ECOS Points';
                            
                            // Обновляем балансы в localStorage
                            localStorage.setItem('btcBalance', newBtcBalance);
                            localStorage.setItem('ecosBalance', newEcosBalance);
                            
                            // Очищаем поля ввода
                            document.getElementById('btc-amount').value = '';
                            document.getElementById('ecos-amount').value = '';
                            
                            // Закрываем модальное окно
                            document.getElementById('exchange-modal').classList.remove('active');
                            
                            // Показываем уведомление об успешном обмене
                            alert(`Successfully exchanged ${btcAmount} BTC for ${Math.floor(ecosAmount)} ECOS Points`);
                        } else {
                            alert('Insufficient BTC balance');
                        }
                    });

                    // Обработчик кнопки No в модальном окне
                    document.getElementById('cancel-exchange').addEventListener('click', () => {
                        document.getElementById('exchange-modal').classList.remove('active');
                    });

                    // Закрытие модального окна при клике вне его содержимого
                    document.getElementById('exchange-modal').addEventListener('click', (e) => {
                        if (e.target === e.currentTarget) {
                            e.currentTarget.classList.remove('active');
                        }
                    });

                    // Инициализируем WebSocket при загрузке экрана
                    initBTCPrice();

                    // Optionally update active class for navigation links
                    document.querySelectorAll('.bottom-nav__link').forEach(link => link.classList.remove('bottom-nav__link--active'));
                    walletButton.classList.add('bottom-nav__link--active');

                     // Clear references to elements that are not on the wallet screen
                    startMiningButton = null;
                    timerDisplay = null;
                    btcBalanceDisplay = null;
                    energyDisplay = null;

                });
            }

        });
    </script>
</body>
</html> 